# Database Schema Specification

**Project**: Evolution of Todo
**Database**: Neon Serverless PostgreSQL
**ORM**: SQLModel (SQLAlchemy + Pydantic)
**Version**: 1.0.0
**Created**: 2025-12-25

---

## Overview

PostgreSQL schema for Evolution of Todo covering Phase II (authentication and tasks) through Phase V (conversations, advanced features).

## Design Principles

1. **UTC Timestamps** - All datetime fields store UTC (per CONSTITUTION.md timezone handling)
2. **VARCHAR for User IDs** - Better Auth generates string IDs (format: `usr_xxxxx`)
3. **SERIAL for Task IDs** - Auto-increment integers for tasks
4. **Foreign Keys** - Enforce referential integrity at database level
5. **Indexes** - On frequently queried columns (user_id, email, completed, created_at)
6. **No Soft Deletes** - Hard deletes only (per CONSTITUTION.md)

---

## Phase II: Users and Tasks

### users

**Purpose:** Store user accounts (Better Auth integration)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | VARCHAR(255) | PRIMARY KEY | User ID from Better Auth (format: usr_xxxxx) |
| email | VARCHAR(255) | UNIQUE, NOT NULL | User email address (unique identifier) |
| name | VARCHAR(255) | NULL | User display name (optional) |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() AT TIME ZONE 'UTC' | Account creation time (UTC) |

**Indexes:**
- PRIMARY KEY on `id`
- UNIQUE INDEX on `email`

**SQL:**
```sql
CREATE TABLE users (
    id VARCHAR(255) PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT (NOW() AT TIME ZONE 'UTC')
);

CREATE UNIQUE INDEX idx_users_email ON users(email);
```

**Notes:**
- `id` generated by Better Auth (we don't control format)
- `email` must be unique (enforced at DB level for data integrity)
- `created_at` stored in UTC (TIMESTAMP WITHOUT TIME ZONE per CONSTITUTION.md)
- `name` optional (user may not provide during registration)

---

### tasks

**Purpose:** Store user tasks with completion status

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | SERIAL | PRIMARY KEY | Auto-increment task ID (starts at 1) |
| user_id | VARCHAR(255) | NOT NULL, FOREIGN KEY → users(id) | Task owner (user who created it) |
| title | VARCHAR(200) | NOT NULL | Task title (1-200 chars validation in app layer) |
| description | VARCHAR(1000) | NOT NULL, DEFAULT '' | Task description (max 1000 chars, empty string if not provided) |
| completed | BOOLEAN | NOT NULL, DEFAULT FALSE | Completion status (false = incomplete, true = complete) |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() AT TIME ZONE 'UTC' | Task creation time (UTC) |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() AT TIME ZONE 'UTC' | Last update time (UTC, updated on every modification) |

**Foreign Keys:**
- `user_id` REFERENCES `users(id)` ON DELETE CASCADE
  - When user deleted, all their tasks automatically deleted

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `user_id` (filter tasks by user - most common query)
- INDEX on `completed` (filter by status - pending/completed)
- INDEX on `created_at` (sort tasks by creation date)

**SQL:**
```sql
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    description VARCHAR(1000) NOT NULL DEFAULT '',
    completed BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT (NOW() AT TIME ZONE 'UTC'),
    updated_at TIMESTAMP NOT NULL DEFAULT (NOW() AT TIME ZONE 'UTC')
);

CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_completed ON tasks(completed);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);
```

**Notes:**
- `id` auto-increments (PostgreSQL SERIAL type)
- Cascade delete ensures orphaned tasks don't remain when user deleted
- `title` and `description` lengths enforced in application layer (SQLModel validation)
- `updated_at` must be updated on every modification (application responsibility)
- All timestamps stored as TIMESTAMP WITHOUT TIME ZONE (application always provides UTC)

---

## Phase III: Conversations (Future)

### conversations

**Purpose:** Store AI chatbot conversations

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | SERIAL | PRIMARY KEY | Auto-increment conversation ID |
| user_id | VARCHAR(255) | NOT NULL, FOREIGN KEY → users(id) | Conversation owner |
| title | VARCHAR(255) | NULL | Conversation title (optional, can be auto-generated) |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() AT TIME ZONE 'UTC' | Conversation start time (UTC) |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() AT TIME ZONE 'UTC' | Last message time (UTC) |

**Foreign Keys:**
- `user_id` REFERENCES `users(id)` ON DELETE CASCADE

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `user_id`
- INDEX on `updated_at` (sort conversations by recent activity)

---

### messages

**Purpose:** Store individual messages in conversations

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | SERIAL | PRIMARY KEY | Auto-increment message ID |
| conversation_id | INTEGER | NOT NULL, FOREIGN KEY → conversations(id) | Parent conversation |
| role | VARCHAR(20) | NOT NULL, CHECK (role IN ('user', 'assistant')) | Message sender |
| content | TEXT | NOT NULL | Message text content |
| tool_calls | JSONB | NULL | MCP tool invocations (JSON array, null if no tools used) |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() AT TIME ZONE 'UTC' | Message timestamp (UTC) |

**Foreign Keys:**
- `conversation_id` REFERENCES `conversations(id)` ON DELETE CASCADE

**Indexes:**
- PRIMARY KEY on `id`
- INDEX on `conversation_id` (load all messages in conversation)
- INDEX on `created_at` (sort messages chronologically)

**Notes:**
- `role` restricted to 'user' or 'assistant' (CHECK constraint)
- `tool_calls` stores JSON array of MCP tool invocations for assistant messages
- Cascade delete removes all messages when conversation deleted

---

## Phase V: Advanced Features (Future)

### Potential Additional Columns for tasks Table

**Phase V may add:**
- `priority` INTEGER (1=low, 2=medium, 3=high)
- `due_date` TIMESTAMP (deadline for task completion)
- `remind_at` TIMESTAMP (reminder notification time)
- `tags` TEXT[] (array of tag strings)
- `recurrence_pattern` VARCHAR(50) (cron pattern for recurring tasks)

**Migration Strategy:** Add columns with DEFAULT values for zero-downtime deployment

---

## Migration Strategy

### Tool: Alembic

**Migration Naming Convention:**
- `001_initial_schema.py` - Create users and tasks tables (Phase II)
- `002_add_conversations.py` - Add conversations and messages (Phase III)
- `003_add_advanced_features.py` - Add priority, tags, due dates (Phase V)

### Migration Process

**Development Workflow:**
1. Modify SQLModel models in `backend/src/models.py`
2. Generate migration:
   ```bash
   alembic revision --autogenerate -m "description"
   ```
3. Review generated migration file
   - Verify `upgrade()` function correct
   - Verify `downgrade()` function correct
4. Test upgrade:
   ```bash
   alembic upgrade head
   ```
5. Test downgrade:
   ```bash
   alembic downgrade -1
   ```
6. Re-test upgrade:
   ```bash
   alembic upgrade head
   ```
7. Commit migration file to git

**Production Deployment:**
1. Apply migrations before deploying new code:
   ```bash
   alembic upgrade head
   ```
2. Deploy application code
3. Rollback if needed:
   ```bash
   alembic downgrade -1
   ```

### Zero-Downtime Migration Guidelines

**Safe Operations:**
- ✅ Add new tables
- ✅ Add columns with DEFAULT values
- ✅ Add indexes CONCURRENTLY (PostgreSQL specific)
- ✅ Add CHECK constraints as NOT VALID, then VALIDATE

**Unsafe Operations (require downtime or two-phase deployment):**
- ❌ Drop columns (deprecate first, drop later)
- ❌ Rename columns (add new, migrate data, drop old)
- ❌ Change column types (add new, migrate, drop old)
- ❌ Add NOT NULL without DEFAULT

**Example Two-Phase Migration:**
```sql
-- Phase 1: Add new column with default
ALTER TABLE tasks ADD COLUMN priority INTEGER DEFAULT 2;

-- Phase 2 (later): Make NOT NULL after data populated
ALTER TABLE tasks ALTER COLUMN priority SET NOT NULL;
```

---

## Connection Configuration

### Connection Pooling

**Settings (per CONSTITUTION.md Section XIII):**
- `pool_size`: 20 (number of connections to maintain)
- `max_overflow`: 40 (additional connections allowed under load)
- `pool_timeout`: 30 seconds (wait time for available connection)
- `pool_recycle`: 3600 seconds (1 hour - recycle connections to prevent stale)

**Rationale:**
- Pool size 20 handles typical load
- Max overflow 40 provides burst capacity
- Recycle prevents connection timeouts from database side

### Environment Variables

**Required:**
- `DATABASE_URL`: PostgreSQL connection string
  - Format: `postgresql://user:password@host:port/database?sslmode=require`
  - Example: `postgresql://user:pass@ep-xxx.neon.tech/todo_dev?sslmode=require`

**Optional:**
- `DB_POOL_SIZE`: Override default pool size (default: 20)
- `DB_MAX_OVERFLOW`: Override max overflow (default: 40)
- `DB_POOL_TIMEOUT`: Override timeout (default: 30)
- `DB_POOL_RECYCLE`: Override recycle time (default: 3600)

### Neon-Specific Configuration

**Connection String Format:**
```
postgresql://[user]:[password]@[endpoint].neon.tech/[database]?sslmode=require
```

**Important:**
- Always use `sslmode=require` for Neon connections
- Endpoint format: `ep-xxxxx.region.neon.tech`
- Default port: 5432 (can be omitted)

---

## Query Patterns

### Common Queries (Optimized by Indexes)

**Get User's Tasks:**
```sql
SELECT * FROM tasks
WHERE user_id = $1
ORDER BY created_at DESC;
```
- Uses: `idx_tasks_user_id`
- Returns: All tasks for user, newest first

**Get Pending Tasks:**
```sql
SELECT * FROM tasks
WHERE user_id = $1 AND completed = FALSE
ORDER BY created_at DESC;
```
- Uses: `idx_tasks_user_id`, `idx_tasks_completed`
- Returns: Incomplete tasks only

**Get Completed Tasks:**
```sql
SELECT * FROM tasks
WHERE user_id = $1 AND completed = TRUE
ORDER BY created_at DESC;
```
- Uses: `idx_tasks_user_id`, `idx_tasks_completed`
- Returns: Completed tasks only

**Update Task:**
```sql
UPDATE tasks
SET title = $1, description = $2, updated_at = NOW() AT TIME ZONE 'UTC'
WHERE id = $3 AND user_id = $4;
```
- User isolation: WHERE clause includes `user_id`
- Always update `updated_at` timestamp

**Delete Task:**
```sql
DELETE FROM tasks
WHERE id = $1 AND user_id = $2;
```
- User isolation: WHERE clause includes `user_id`
- Prevents users from deleting other users' tasks

---

## Security Considerations

### User Isolation

**Enforcement at Database Query Level:**
- ALL queries MUST include `user_id` filter in WHERE clause
- NEVER query by ID alone without user_id check
- Prevents unauthorized access to other users' data

**Example - WRONG:**
```sql
SELECT * FROM tasks WHERE id = 123;  -- ❌ NO user_id check!
```

**Example - CORRECT:**
```sql
SELECT * FROM tasks WHERE id = 123 AND user_id = 'usr_abc';  -- ✓ User isolation
```

### SQL Injection Prevention

- Use SQLModel ORM (parameterized queries)
- NEVER construct SQL strings with user input
- All user input validated before database operations

### Data Privacy

- Users can ONLY access their own data
- No global admin views (Phase II-III)
- Database enforces foreign key constraints

---

## Acceptance Criteria

- [x] users table schema complete with all fields
- [x] tasks table schema complete with all fields
- [x] Foreign keys documented (tasks.user_id → users.id)
- [x] Indexes documented for performance
- [x] UTC timezone strategy documented
- [x] Migration strategy documented (Alembic)
- [x] Connection pooling configuration documented
- [x] Zero-downtime migration guidelines provided
- [x] Query patterns documented
- [x] Security considerations documented

---

## References

- [CONSTITUTION.md - Database Strategy](../../.specify/memory/constitution.md#database-strategy)
- [CONSTITUTION.md - Timezone Handling](../../.specify/memory/constitution.md#timezone-handling)
- [specs/technical/database-migrations.md](../technical/database-migrations.md)
- [specs/technical/timezone-handling.md](../technical/timezone-handling.md)

---

**Version:** 1.0.0 (Phase II)
**Last Updated:** 2025-12-25
**Next Update:** Phase III (add conversations and messages tables)
